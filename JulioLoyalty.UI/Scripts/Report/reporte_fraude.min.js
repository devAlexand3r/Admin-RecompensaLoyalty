
$(function (e) {
    var reporte = {
        urlAPI: {
            url_reporte_fraude: appBaseUrl + '/api/Report/Fraude'
        },
        webControls: {
            txtFecha: $('#start_date'),
            selTipoTienda: $('#selReportType'),
            btnConsultar: $('#btnConsultar'),
            table_reporte_dinamico: $('#tabla_reporte_dinamico')
        },
        valido: {
            fecha: false
        },
        selValues: {
            rolTienda: $('#hidRole').val()
        },
        iniciar: function () {
            this.agregarEventos();
            $('.date').datepicker({
                format: "dd/mm/yyyy",
                language: 'es',
                autoclose: true,
                todayHighlight: true
            });
            var hoy = new Date();
            var primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            this.webControls.txtFecha.datepicker().datepicker("setEndDate", hoy);
            this.webControls.txtFecha.datepicker().datepicker('setDate', new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()));
            if (reporte.selValues.rolTienda === "9699e07c-4546-46eb-8456-4a5777c1fb77") { // Para el Rol Tienda solo permite consultar el mes actual
                this.webControls.txtFecha.datepicker().datepicker("setStartDate", primerDiaMes);
            }
            $('.selectpicker').selectpicker({
                language: 'es',
                //title: 'Mostrar Todos'
            }).selectpicker('refresh');
        },
        agregarEventos: function () {
            this.webControls.txtFecha.change(function () {
                reporte.valido.fecha = reporte.Requerido(this, 'date');
            });
            this.webControls.btnConsultar.click(function () {
                reporte.obtenerReporteDinamico();
            });
        },

        Requerido: function (thisObj, type) {
            var valido = true;
            $("div[data-valmsg-for=" + thisObj.name + "]").addClass('hidden');
            if (type === 'date') {
                var vregexNaix = /^(0[1-9]|[1-2]\d|3[01])(\/)(0[1-9]|1[012])\2(\d{4})$/;
                if (!vregexNaix.test(thisObj.value) || thisObj.value.length > 10) {
                    $("div[data-valmsg-for=" + thisObj.name + "]").removeClass('hidden');
                    $("[name=" + thisObj.name + "]").addClass('is-invalid');
                    valido = false;
                }
            }
            if (valido === true) {
                $("[name=" + thisObj.name + "]").removeClass('is-invalid');
                $("[name=" + thisObj.name + "]").addClass('is-valid');
            }
            return valido;
        },
        maysPrimera: function (texto) {
            return texto.charAt(0).toUpperCase() + texto.slice(1).toLowerCase()
        },
        formatoMembresia: function (number) {
            return '\u200C' + number; // Corrige el problema al exportar a excel con números de 16 digitos
        },
        obtenerReporteDinamico: function () {
            this.webControls.txtFecha.trigger('change');
            if (this.valido.fecha === true) {
                // Bloquea página para procesar  
                $.blockUI({
                    css: {
                        border: 'none',
                        padding: '15px',
                        backgroundColor: '#000',
                        '-webkit-border-radius': '10px',
                        '-moz-border-radius': '10px',
                        opacity: .5,
                        color: '#fff'
                    },
                    message: "Procesando..."
                });
                var dataResult = [];
                var rcolumns = [];
                $.getJSON(this.urlAPI.url_reporte_fraude,
                    {
                        fecha: reporte.webControls.txtFecha.val(),
                        tipo_reporte: reporte.webControls.selTipoTienda.val()
                    },
                    function (json) {
                        var array = JSON.parse(json);
                        if (array.length > 0) {
                            $('#pNotFound').attr('style', 'display:none');
                            const types = Object.keys(array[0]);
                            var columnDefault = [];
                            $.each(types, function (index, name) {
                                if (index === 2)
                                    columnDefault.push({ visible: false, targets: 0 });
                                if (name.toLowerCase() === "membresia") {
                                    const add = {
                                        sTitle: name,
                                        mData: name,
                                        mRender: function (data, type, row) {
                                            return reporte.formatoMembresia(data);
                                        }
                                    }
                                    rcolumns.push(add);
                                }
                                else {
                                    const add = { sTitle: name.replace('_', ' '), mData: name }
                                    rcolumns.push(add);
                                }
                            });
                        } else {
                            $("#pNotFound").removeAttr('style');
                            if ($.fn.DataTable.isDataTable(reporte.webControls.table_reporte_dinamico)) {
                                reporte.webControls.table_reporte_dinamico.DataTable().clear().destroy();
                                reporte.webControls.table_reporte_dinamico.empty();
                            }
                            setTimeout($.unblockUI, 2000); // Después desbloquea página
                            return;
                        }

                        var buttonExport = [];
                        var conf = {
                            extend: 'excel',
                            text: 'Exportar a Excel',
                            className: 'btn btn-primary',
                            title: "Reporte_Fraude",
                            exportOptions: {
                                columns: ':visible'
                            }
                        };
                        if (reporte.selValues.rolTienda !== "9699e07c-4546-46eb-8456-4a5777c1fb77") { // Sino es Rol Tienda Muestra el Botón Exportar Excel
                            buttonExport.push(conf);
                        }

                        dataResult.push({
                            aaData: array,
                            aoColumns: rcolumns,
                            aoColumnDefs: columnDefault,
                            oLanguage: {
                                sUrl: '//cdn.datatables.net/plug-ins/1.10.15/i18n/Spanish.json'
                            },
                            rowId: 'id',
                            bDestroy: true,
                            bLengthChange: false,
                            bScrollCollapse: true,
                            paging: true,
                            searching: true,
                            ordering: true,
                            info: true,
                            dom: 'Bfrtip',
                            buttons: buttonExport
                        });
                        reporte.webControls.table_reporte_dinamico.DataTable(dataResult[0]);
                        setTimeout($.unblockUI, 2000); // Después desbloquea página                    
                    });
            }
        },
    };
    reporte.iniciar();

});