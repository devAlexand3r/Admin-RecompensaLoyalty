
var global = {};
var objectRow = null;

var objRowFunction = null;
$(function (e) {
    var main = {
        URL_GET_MENUS: appBaseUrl + 'api/Service/GetMenu',
        URL_GET_SUBMENUS: appBaseUrl + 'api/Service/GetSubMenu',
        URL_UPDATE_ACTION: appBaseUrl + 'api/update/AddOrUpdateAction',
        URL_DELETE_ACTION: appBaseUrl + 'api/update/DeleteAction',


        displayTable: $('#tablemenu'),
        table_submenus: $('#table_funcion'),

        txtName: $('#Name'),
        txtController: $('#Controller'),
        txtActionResult: $('#ActionResult'),
        btnSaveOrUpdate: $('#btnUpdateMenu'),

        ejecutar: function () {
        },

        init: function () {
            this.loadMenus();
            //Tabla de menus
            main.displayTable.on('click', 'tr', function (event) {
                objectRow = main.displayTable.DataTable().row(this).data();
                var event_tarjet = $(event.target).attr('class');

                if (event_tarjet === 'fas fa-external-link-alt' || event_tarjet === 'btn btn-info btn-sm') {
                    $('.editm').on('shown.bs.modal', function () {
                        main.loadSubMenus(objectRow.Id);
                        main.txtName.val('');
                        main.txtController.val('');
                        main.txtActionResult.val('');
                        $('.checkbox').prop('checked', true);
                    });
                }

            });
            // Tabla de submenus
            main.table_submenus.on('click', 'tr', function (event) {
                objRowFunction = main.table_submenus.DataTable().row(this).data();

                main.txtName.val(objRowFunction.Name);
                main.txtController.val(objRowFunction.ControllerName);
                main.txtActionResult.val(objRowFunction.ActionName);
                $('.checkbox').prop('checked', objRowFunction.IsActive);

                var event_tarjet = $(event.target).attr('class');
                if (event_tarjet === 'fas fa-trash-alt' || event_tarjet === 'btn btn-danger btn-sm') {

                    //swal({
                    //    title: "Advertencia",
                    //    text: '¿Esta seguro de eliminar ' + objRowFunction.Name + '?',
                    //    icon: "warning",
                    //    buttons: true,
                    //    dangerMode: true,
                    //    buttons: ["Cancelar", "Aceptar"],
                    //}).then((willDelete) => {
                    //    if (willDelete) {
                    //        main.deleteAction(objRowFunction.Id);
                    //    }
                    //});


                    //main.ejecutar.prototype.metodo = function () {
                    //    main.deleteAction(objRowFunction.Id);
                    //};
                    //$swal.confirmation('Alerta', 'warning', '¿Esta seguro de eliminar ' + objRowFunction.Name + '?', main);
                }

            });

            //Guardar o actualizar acción
            main.btnSaveOrUpdate.click(function () {
                main.saveOrUpdate();
            });

        },
        saveOrUpdate: function () {

            var obj = {
                IdMenu: objectRow.Id,
                Name: main.txtName.val(),
                Controller: main.txtController.val(),
                Action: main.txtActionResult.val(),
                IsActive: $('input[name=active]').is(":checked"),
            };
            $.ajax({
                url: this.URL_UPDATE_ACTION,
                type: 'POST',
                async: false,
                data: obj,
            }).done(function (result, textStatus, xhr) {
                if (result.Success === true) {
                    main.loadSubMenus(objectRow.Id);
                    swal({
                        title: "Atención",
                        text: 'Registro actualizado con éxito',
                        icon: "success",
                        button: "Aceptar",
                        closeOnClickOutside: false
                    });
                }
                if (result.Success === false) {
                    swal({
                        title: 'Alerta',
                        text: result.Message,
                        icon: "warning",
                        button: "Aceptar",
                        closeOnClickOutside: false
                    });
                }
            }).fail(function (data, textStatus, xhr) {
                console.log(data, textStatus, xhr);
            });

        },


        loadMenus: function () {
            main.displayTable.DataTable().destroy();
            main.displayTable.DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.15/i18n/Spanish.json'
                },
                ajax: {
                    url: main.URL_GET_MENUS
                },
                lengthChange: false,
                processing: true,
                rowId: 'Id',
                scrollY: '50vh',
                scrollCollapse: true,
                ordering: false,
                columns: [
                    { data: "Name", },
                    {
                        data: "Id",
                        render: function (data, type, row) {
                            return 'Ver detalle <i class="fas fa-angle-double-right text-info"></i>';
                            //return main.Formatter(row);
                        }
                    },
                    {
                        data: "Id",
                        width: "50px",
                        render: function (data, type, row) {
                            var btn = '<div style="text-align:center;"> <button class="btn btn-info btn-sm" title="Editar menú" data-toggle="modal" data-target="#edit" data-backdrop="static" data-keyboard="false"><i class="fas fa-external-link-alt"></i></button>';
                            return btn;
                        }
                    }
                ]

            });
        },
        loadSubMenus: function (id) {
            main.table_submenus.DataTable().destroy();
            main.table_submenus.DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.15/i18n/Spanish.json'
                },
                ajax: {
                    url: main.URL_GET_SUBMENUS,
                    type: 'GET',
                    data: function (d) {
                        d.Id = id;
                    }
                },
                lengthChange: false,
                processing: true,
                rowId: 'Id',
                scrollY: '30vh',
                scrollCollapse: true,
                ordering: false,
                paging: true,
                searching: false,
                columns: [
                    { data: "Name", },
                    { data: "ControllerName", },
                    { data: "ActionName", },
                    {
                        data: "Id",
                        width: "20px",
                        render: function (data, type, row) {
                            if (row.IsActive === false) {
                                return '<div style="text-align:center;"> <button class="btn btn-danger btn-sm" title="Eliminar"><i class="fas fa-trash-alt"></i></button>';
                            }
                            return '';
                        }
                    }
                ]

            });
        },
        Formatter: function (data) {
            if (data.SubMenu.length === 0)
                return '';

            var result = '<ul>';
            $.each(data.SubMenu, function (index, row) {
                result += '<li>' + row.Name + '</li>'
            });
            result += '</ul>';
            return result;
        },
        deleteAction: function (id) {

            main.table_submenus.DataTable().row("#" + id).remove().draw(false);
            swal({
                title: "Transacción exitosa",
                text: 'Registro eliminado con éxito',
                icon: "success",
                button: "Aceptar",
                closeOnClickOutside: false
            });
            //$.ajax({
            //    url: main.URL_DELETE_ACTION,
            //    type: 'GET',
            //    async: false,
            //    data: {
            //        Id: id
            //    },
            //}).done(function (result, textStatus, xhr) {
            //    if (result.Success === true) {
            //        main.loadSubMenus(objectRow.Id);
            //        $.notify({
            //            icon: 'glyphicon glyphicon-ok',
            //            message: result.Message
            //        });
            //    }
            //    if (result.Success === false) {
            //        $.notify({
            //            icon: 'glyphicon glyphicon-remove',
            //            message: result.Message
            //        });
            //    }

            //}).fail(function (data, textStatus, xhr) {
            //    console.log(data, textStatus, xhr);
            //});
        }

    };

    global.main = main;
    main.init();

});