
var global = {};
$(function (e) {
    var principal = {

        url_buscar_sexo: appBaseUrl + '/api/Direccion/Sexo',
        url_buscar_estados: appBaseUrl + '/api/Direccion/Estados',
        url_buscar_municipios: appBaseUrl + '/api/Direccion/Municipios',
        url_buscar_colonias: appBaseUrl + '/api/Direccion/Colonias',
        url_buscar_codigopostal: appBaseUrl + '/api/Direccion/CodigoPostal',


        selectGenero: $('#genero'),
        selectEstado: $('#direccion_estado'),
        selectMunicipio: $('#direccion_municipio'),
        selectColonia: $('#direccion_colonia'),
        inputCodPostal: $('#direccion_codPostal'),
        btnBusquedaDir: $('#direccion_busqueda'),


        iniciar: function () {

            $(".numeric").on("keypress keyup blur", function (event) {
                $(this).val($(this).val().replace(/[^\d].+/, ""));
                if ((event.which < 48 || event.which > 57)) {
                    event.preventDefault();
                }
            });

            this.obtenerSexo();
            this.obtenerEstados();
            this.selectEstado.on('change', function () {
                principal.obtenerMunicipios(this.value);
            });
            this.selectMunicipio.on('change', function () {
                principal.obtenerColonias(this.value);

            });
            this.selectColonia.on('change', function () {
                principal.obtenerCodigoPostal(this.value);
            });

            this.btnBusquedaDir.click(function () {
                var codPostal = principal.inputCodPostal.val();

                $('div[data-valmsg-for="CodigoPostal"]').removeClass('hidden');
                if (codPostal === "") {
                    $('div[data-valmsg-for="CodigoPostal"]').text("Código postal invalido");
                    return;
                }

                if (codPostal.length < 5) {
                    $('div[data-valmsg-for="CodigoPostal"]').text("El código postal debe ser de 5 digitos");
                    return;
                }
                $('div[data-valmsg-for="CodigoPostal"]').addClass('hidden');

                $.ajax({
                    url: '/api/Direccion/BusquedaCP',
                    type: 'GET',
                    dataType: 'json',
                    data: {
                        codigo_postal: codPostal,
                    },
                    success: function (data) {
                        if (data.length > 0) {
                            principal.selectEstado.val(data[0].estado).trigger('change');
                            principal.selectMunicipio.val(data[0].municipio).trigger('change');
                            principal.selectColonia.val(data[0].colonia).selectpicker("refresh");
                        } else {
                            var mensaje = "El siguiente código " + codPostal + " no fue encontrado";
                            principal.mensajeAdvertencia(mensaje);
                        }

                    }, error: function (xhr, status, error) {
                        var mensaje = "Status: " + xhr.status + " Error: " + error;
                        principal.mensajeError(mensaje);
                    }
                });

            });

            principal.selectEstado.selectpicker({ title: 'Seleccione estado' });
            principal.selectEstado.selectpicker("refresh");
            principal.selectMunicipio.selectpicker({ title: 'Seleccione municipio' });
            principal.selectMunicipio.selectpicker("refresh");
            principal.selectColonia.selectpicker({ title: 'Seleccione colonia' });
            principal.selectColonia.selectpicker("refresh");


        },

        obtenerEstados: function () {
            $.ajax({
                url: principal.url_buscar_estados,
                type: 'GET',
                async: false,
            }).done(function (data, textStatus, xhr) {
                $Utils.addSelectOptions(data, principal.selectEstado, 'Id', 'Descripcion');
                principal.selectEstado.selectpicker("refresh");
            }).fail(function (data, textStatus, xhr) {
                console.log(data, textStatus, xhr);
            });
        },
        obtenerMunicipios: function (keyEstado) {
            $.ajax({
                url: principal.url_buscar_municipios,
                type: 'GET',
                async: false,
                data: { estado: keyEstado }
            }).done(function (data, textStatus, xhr) {
                principal.selectMunicipio.attr('disabled', false);
                $Utils.addSelectOptions(data, principal.selectMunicipio, 'Id', 'Descripcion');
                principal.selectMunicipio.selectpicker("refresh");
            }).fail(function (data, textStatus, xhr) {
                console.log(data, textStatus, xhr);
            });
        },
        obtenerColonias: function (keyMunicipio) {
            $.ajax({
                url: principal.url_buscar_colonias,
                type: 'GET',
                async: false,
                data: {
                    estado: principal.selectEstado.val(),
                    municipio: keyMunicipio,
                    codigopostal: ""
                }
            }).done(function (data, textStatus, xhr) {
                principal.selectColonia.attr('disabled', false);
                $Utils.addSelectOptions(data, principal.selectColonia, 'Id', 'Descripcion');
                principal.selectColonia.selectpicker("refresh");
            }).fail(function (data, textStatus, xhr) {
                console.log(data, textStatus, xhr);
            });
        },
        obtenerCodigoPostal: function (keyColonia) {
            $.ajax({
                url: principal.url_buscar_codigopostal,
                type: 'GET',
                async: false,
                data: {
                    estado: principal.selectEstado.val(),
                    municipio: principal.selectMunicipio.val(),
                    colonia: keyColonia
                }
            }).done(function (data, textStatus, xhr) {
                console.log(data);
                principal.inputCodPostal.val(JSON.stringify(data.CodigoPostal).replace(/"/g, ''));
            }).fail(function (data, textStatus, xhr) {
                console.log(data, textStatus, xhr);
            });
        },
        obtenerSexo: function () {
            $.ajax({
                url: principal.url_buscar_sexo,
                type: 'GET',
                async: false,
            }).done(function (data, textStatus, xhr) {
                $Utils.addSelectOptions(data, principal.selectGenero, 'id', 'descripcion');
                principal.selectGenero.selectpicker({ title: 'Seleccione sexo' });
                principal.selectGenero.selectpicker("refresh");
            }).fail(function (data, textStatus, xhr) {
                console.log(data, textStatus, xhr);
            });
        },

        mensajeAdvertencia: function (mensaje) {
            swal({
                title: 'Alerta!',
                type: 'warning',
                html: mensaje,
                confirmButtonColor: '#11ACA6',
                confirmButtonText: 'Aceptar',
            });
        },
        mensajeExito: function (mensaje) {
            swal({
                title: 'Exito!',
                type: 'success',
                html: mensaje,
                confirmButtonColor: '#11ACA6',
                confirmButtonText: 'Aceptar',
            });
        },
        mensajeError: function (mensaje) {
            swal({
                title: 'Error!',
                type: 'danger',
                html: mensaje,
                confirmButtonColor: '#11ACA6',
                confirmButtonText: 'Aceptar',
            });
        }

    };


    global.principal = principal;
    principal.iniciar();


});